const User = require('../models/User')
const bcrypt = require('bcrypt')
const jwt = require('jsonwebtoken')

require('dotenv').config

const authUser = async (req, res) => {

    try {
        const [user, pwd] = req.body;
        if (!user || !pwd) {return 
            res.status(404).json("user not found")
            console.log("username/password not included")
        }
        const foundUser = User.findOne({username: user})
        if(!foundUser) {
            console.log("User not found")
            res.send(404).json({"User not found": `${user} does not exist in db`})
        }
        const match = bcrypt.compare(pwd, foundUser.password)
    
        if(match){
            const accessToken = jwt.sign(
                {id: foundUser._id.toString},
                process.env.ACCESS_TOKEN_SECRET,
                { expiresIn: '15m'}
            )
            const refreshToken = jwt.sign(
                {id: foundUser._id.toString},
                process.env.REFRESH_TOKEN_SECRET,
                { expiresIn: '24h' }
            )
            
            foundUser.refreshToken = refreshToken;
    
            res.cookie('jwt', refreshToken, { httpOnly: true, maxAge: 24*60*60 *1000})
            
        } else {
            console.log("incorrect info")
            res.send(401).json({"message": "incorrectinfo"})
        }
    } catch (err) {
        console.log("Error authenticating user", err)
        res.send(500)
    }
    
}

module.exports = authUser;